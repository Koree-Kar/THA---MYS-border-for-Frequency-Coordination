<!DOCTYPE html>
<html>
  <head>
    <title>Pin Location and Measure Distance</title>
    <style>
      /* Reset margins and paddings */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      /* Style for the map to fill the browser window */
      #map {
        height: calc(100% - 60px); /* Subtract the height of the title and search box */
        width: 100%;
      }
      /* Style for the title */
      #title {
        text-align: center;
        font-size: 24px;
        margin-top: 10px;
      }
      /* Style for the search box */
      #pac-input {
        margin: 10px auto;
        padding: 5px;
        font-size: 14px;
        width: 300px;
        display: block;
      }
    </style>
    <!-- Include the Places library for the Search Box -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBivO_Cvi7SOtiuVdwkYKIlP-gYilolWHo&libraries=places"></script>
    <script>
      function initMap() {
        var map = new google.maps.Map(document.getElementById("map"), {
          zoom: 8,
          center: { lat: 6.556, lng: 101.26 }, // Centered around Pattani, Yala, etc.
        });

        // List of border points between Thailand and mainland Malaysia
        var borderPoints = [
          { lat: 6.42380494339016, lng: 100.12618372151695 },
          { lat: 6.57684399588934, lng: 100.15913745992208 },
          { lat: 6.69685571690287, lng: 100.17264629126859 },
          { lat: 6.57684399588934, lng: 100.15913745992208 },
          { lat: 6.70369902954901, lng: 100.28863736265964 },
          { lat: 6.65854612239782, lng: 100.32559710188178 },
          { lat: 6.60480914237183, lng: 100.31136130867179 },
          { lat: 6.53695594930505, lng: 100.36828588258902 },
          { lat: 6.52554924317088, lng: 100.49075271111565 },
          { lat: 6.48876933468697, lng: 100.51352805898091 },
          { lat: 6.4887519269273, lng: 100.56476494326745 },
          { lat: 6.4463533538283, lng: 100.64731943298085 },
          { lat: 6.50010794680665, lng: 100.73842191690386 },
          { lat: 6.44351139497531, lng: 100.81240927752162 },
          { lat: 6.31621715485884, lng: 100.84373699019153 },
          { lat: 6.23132857952313, lng: 100.85229365025498 },
          { lat: 6.2652859964029, lng: 100.87789514751023 },
          { lat: 6.245477799598, lng: 100.94040494185867 },
          { lat: 6.28225181873332, lng: 100.97455274995082 },
          { lat: 6.24264926805632, lng: 101.01996962127981 },
          { lat: 6.25679328186439, lng: 101.11400057427 },
          { lat: 6.19739620406133, lng: 101.12523889923267 },
          { lat: 6.14653429650334, lng: 101.06521898683985 },
          { lat: 6.10693363812943, lng: 101.1250101079209 },
          { lat: 5.91454675193386, lng: 101.08814171975592 },
          { lat: 5.91734521863973, lng: 101.02560770840023 },
          { lat: 5.79540165884427, lng: 100.9860287376107 },
          { lat: 5.73599063853912, lng: 101.05997457354755 },
          { lat: 5.61728442780366, lng: 101.1394393411287 },
          { lat: 5.81296065194952, lng: 101.28393931127391 },
          { lat: 5.92579800600859, lng: 101.58329209821193 },
          { lat: 5.86919737294228, lng: 101.65726545614825 },
          { lat: 5.75617498974624, lng: 101.69664071440587 },
          { lat: 5.79287561161309, lng: 101.75942787419132 },
          { lat: 5.73337532798269, lng: 101.81648651361468 },
          { lat: 5.78990911823258, lng: 101.84230345495052 },
          { lat: 5.84350474807467, lng: 101.89129597410977 },
          { lat: 5.87175529895452, lng: 101.9399380877552 },
          { lat: 5.91704655873411, lng: 101.92294795272426 },
          { lat: 6.03028575057359, lng: 101.9715898202499 },
          { lat: 6.07559478563763, lng: 102.05134608220044 },
          { lat: 6.1463826055745, lng: 102.09127569371321 },
          { lat: 6.18602308579411, lng: 102.0741948497257 },
          { lat: 6.23415446034977, lng: 102.08844030652511 },
          { lat: 6.23415445784547, lng: 102.09128867651987 },
        ];

        // Create the search box and link it to the UI element.
        var input = document.getElementById("pac-input");
        var searchBox = new google.maps.places.SearchBox(input);
        map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

        // Bias the SearchBox results towards current map's viewport.
        map.addListener("bounds_changed", function() {
          searchBox.setBounds(map.getBounds());
        });

        var markers = [];

        // Listen for the event fired when the user selects a prediction and retrieve more details.
        searchBox.addListener("places_changed", function() {
          var places = searchBox.getPlaces();

          if (places.length == 0) {
            return;
          }

          // Clear out the old markers.
          markers.forEach(function(marker) {
            marker.setMap(null);
          });
          markers = [];

          // For each place, get the icon, name and location.
          var bounds = new google.maps.LatLngBounds();
          places.forEach(function(place) {
            if (!place.geometry) {
              console.log("Returned place contains no geometry");
              return;
            }

            // Create a marker for each place.
            var marker = new google.maps.Marker({
              map: map,
              title: place.name,
              position: place.geometry.location,
            });

            markers.push(marker);

            // Get lat/lng of the place
            var lat = place.geometry.location.lat();
            var lng = place.geometry.location.lng();

            // Calculate distance from the place to the nearest borderline point
            var minDistance = calculateMinDistance(lat, lng, borderPoints);

            // Determine frequency registration alert
            var frequencyAlert = '';
            if (minDistance <= 30) {
              frequencyAlert = "UHF Frequency Registration";
            } else if (minDistance <= 60) {
              frequencyAlert = "UHF and VHF Frequency Registration";
            } else {
              frequencyAlert = "No Frequency Registration";
            }

            // Create an InfoWindow to display information
            var infoWindow = new google.maps.InfoWindow({
              content: `
                <div>
                  <p><strong>Coordinates:</strong> Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}</p>
                  <p><strong>Nearest Distance to Border:</strong> ${minDistance.toFixed(2)} KM</p>
                  <p><strong>Frequency Registration:</strong> ${frequencyAlert}</p>
                </div>`,
            });
            infoWindow.open(map, marker);

            if (place.geometry.viewport) {
              bounds.union(place.geometry.viewport);
            } else {
              bounds.extend(place.geometry.location);
            }
          });
          map.fitBounds(bounds);
        });

        // Add click event listener to drop a pin and calculate distance
        map.addListener("click", function (event) {
          // Clear any previous markers
          map.markers = map.markers || [];
          map.markers.forEach(marker => marker.setMap(null));

          // Drop the pin where user clicks
          var pin = new google.maps.Marker({
            position: event.latLng,
            map: map,
          });
          map.markers.push(pin);

          // Get lat/lng of the pin
          var lat = event.latLng.lat();
          var lng = event.latLng.lng();
        
          // Calculate distance from the pin to the nearest borderline point
          var minDistance = calculateMinDistance(lat, lng, borderPoints);
          
          // Determine frequency registration alert
          var frequencyAlert = '';
          if (minDistance <= 30) {
            frequencyAlert = "UHF Frequency Registration";
          } else if (minDistance <= 60) {
            frequencyAlert = "UHF and VHF Frequency Registration";
          } else {
            frequencyAlert = "No Frequency Registration";
          }

          // Create an InfoWindow to display information
          var infoWindow = new google.maps.InfoWindow({
            content: `
              <div>
                <p><strong>Coordinates:</strong> Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}</p>
                <p><strong>Nearest Distance to Border:</strong> ${minDistance.toFixed(2)} KM</p>
                <p><strong>Frequency Registration:</strong> ${frequencyAlert}</p>
              </div>`,
          });
          infoWindow.open(map, pin);
        });

        // Create the "My Location" button
        var locationButtonDiv = document.createElement('div');
        createLocationButton(locationButtonDiv, map, borderPoints);
        map.controls[google.maps.ControlPosition.RIGHT_TOP].push(locationButtonDiv);
      }

      // Function to create the "My Location" button
      function createLocationButton(controlDiv, map, borderPoints) {
        // Set CSS for the control border.
        var controlUI = document.createElement('div');
        controlUI.style.backgroundColor = '#fff';
        controlUI.style.border = '2px solid #fff';
        controlUI.style.borderRadius = '3px';
        controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
        controlUI.style.cursor = 'pointer';
        controlUI.style.marginTop = '10px';
        controlUI.style.marginRight = '10px';
        controlUI.style.textAlign = 'center';
        controlUI.title = 'Click to locate your position';
        controlDiv.appendChild(controlUI);

        // Set CSS for the control interior.
        var controlText = document.createElement('div');
        controlText.style.color = 'rgb(25,25,25)';
        controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
        controlText.style.fontSize = '16px';
        controlText.style.lineHeight = '38px';
        controlText.style.paddingLeft = '5px';
        controlText.style.paddingRight = '5px';
        controlText.innerHTML = 'My Location';
        controlUI.appendChild(controlText);

        // Setup the click event listeners: geolocate user.
        controlUI.addEventListener('click', function() {
          // Try HTML5 geolocation.
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
              var pos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };

              // Clear any previous markers
              map.markers = map.markers || [];
              map.markers.forEach(marker => marker.setMap(null));

              // Drop the pin at user's location
              var pin = new google.maps.Marker({
                position: pos,
                map: map,
              });
              map.markers.push(pin);

              // Calculate distance from the pin to the nearest borderline point
              var minDistance = calculateMinDistance(pos.lat, pos.lng, borderPoints);

              // Determine frequency registration alert
              var frequencyAlert = '';
              if (minDistance <= 30) {
                frequencyAlert = "UHF Frequency Registration";
              } else if (minDistance <= 60) {
                frequencyAlert = "UHF and VHF Frequency Registration";
              } else {
                frequencyAlert = "No Frequency Registration";
              }

              // Create an InfoWindow to display information
              var infoWindow = new google.maps.InfoWindow({
                content: `
                  <div>
                    <p><strong>Coordinates:</strong> Lat: ${pos.lat.toFixed(6)}, Lng: ${pos.lng.toFixed(6)}</p>
                    <p><strong>Nearest Distance to Border:</strong> ${minDistance.toFixed(2)} KM</p>
                    <p><strong>Frequency Registration:</strong> ${frequencyAlert}</p>
                  </div>`,
              });
              infoWindow.open(map, pin);

              map.setCenter(pos);
            }, function() {
              handleLocationError(true, map.getCenter());
            });
          } else {
            // Browser doesn't support Geolocation
            handleLocationError(false, map.getCenter());
          }
        });
      }

      function handleLocationError(browserHasGeolocation, pos) {
        alert(browserHasGeolocation
          ? 'Error: The Geolocation service failed.'
          : 'Error: Your browser doesn\'t support geolocation.');
      }

      // Function to calculate the nearest distance between pin and border points
      function calculateMinDistance(lat, lng, borderPoints) {
        var R = 6371; // Radius of the Earth in km
        var minDistance = Infinity;

        borderPoints.forEach(function (borderPoint) {
          var dLat = degreesToRadians(borderPoint.lat - lat);
          var dLng = degreesToRadians(borderPoint.lng - lng);
          var a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(degreesToRadians(lat)) *
              Math.cos(degreesToRadians(borderPoint.lat)) *
              Math.sin(dLng / 2) *
              Math.sin(dLng / 2);
          var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
          var distance = R * c; // Distance in km

          if (distance < minDistance) {
            minDistance = distance;
          }
        });

        return minDistance;
      }

      function degreesToRadians(degrees) {
        return (degrees * Math.PI) / 180;
      }
    </script>
  </head>
  <body onload="initMap()">
    <div id="title">Thailand - Malaysia border for Frequency Registration</div>
    <input id="pac-input" class="controls" type="text" placeholder="Search Box" />
    <div id="map"></div>
  </body>
</html>
